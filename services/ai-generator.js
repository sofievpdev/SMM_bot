import Anthropic from '@anthropic-ai/sdk';
import { config } from '../config/config.js';
import { logger } from '../utils/logger.js';

const client = new Anthropic({
  apiKey: config.claudeApiKey,
});

/**
 * –û–±—Ä–µ–∑–∞–µ—Ç —Ç–µ–∫—Å—Ç –Ω–∞ –ø–æ–ª–Ω–æ–º —Å–ª–æ–≤–µ, –Ω–µ —Ä–∞–∑—Ä–µ–∑–∞—è —Å–ª–æ–≤–æ –ø–æ–ø–æ–ª–∞–º
 * –¢–∞–∫–∂–µ —É–±–∏—Ä–∞–µ—Ç –Ω–µ–ø–æ–ª–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –≤ –∫–æ–Ω—Ü–µ
 * @param {string} text - –ò—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç
 * @param {number} maxLength - –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 4096 –¥–ª—è Telegram, 2048 –µ—Å–ª–∏ —Å –∫–∞—Ä—Ç–∏–Ω–∫–æ–π)
 * @returns {string} - –û–±—Ä–µ–∑–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
 */
function trimTextAtWordBoundary(text, maxLength = 4096) {
  if (!text || text.length <= maxLength) {
    return text;
  }

  // –û–±—Ä–µ–∑–∞–µ–º –¥–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –¥–ª–∏–Ω—ã
  let trimmed = text.substring(0, maxLength);

  // 1. –°–ù–ê–ß–ê–õ–ê –∏—â–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é –ü–û–õ–ù–£–Æ –ø—É–Ω–∫—Ç—É–∞—Ü–∏—é (. ! ?)
  const lastPeriodIndex = Math.max(
    trimmed.lastIndexOf('.'),
    trimmed.lastIndexOf('!'),
    trimmed.lastIndexOf('?')
  );

  // 2. –ï—Å–ª–∏ –Ω–∞—à–ª–∏ –ø—É–Ω–∫—Ç—É–∞—Ü–∏—é –≤ —Ç–µ–∫—Å—Ç–µ - –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ—ë
  if (lastPeriodIndex > 0) {
    // –û–±—Ä–µ–∑–∞–µ–º —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –ø—É–Ω–∫—Ç—É–∞—Ü–∏–∏
    trimmed = trimmed.substring(0, lastPeriodIndex + 1);
  } else {
    // 3. –ï—Å–ª–∏ –ø—É–Ω–∫—Ç—É–∞—Ü–∏–∏ –Ω–µ—Ç - –æ–±—Ä–µ–∑–∞–µ–º –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–º –ø–æ–ª–Ω–æ–º —Å–ª–æ–≤–µ
    const lastSpaceIndex = trimmed.lastIndexOf(' ');

    if (lastSpaceIndex > 0) {
      trimmed = trimmed.substring(0, lastSpaceIndex);
    }
  }

  // 4. –£–¥–∞–ª—è–µ–º –Ω–µ–∑–∞–∫–æ–Ω—á–µ–Ω–Ω—É—é —Ä–∞–∑–º–µ—Ç–∫—É –≤ –∫–æ–Ω—Ü–µ (**, #, –ª–∏—à–Ω–∏–µ —ç–º–æ–¥–∑–∏ –∏ —Ç.–¥.)
  trimmed = trimmed
    .replace(/\*\*\s*$/, '') // –£–¥–∞–ª–∏—Ç—å ** –≤ –∫–æ–Ω—Ü–µ
    .replace(/#+\s*$/, '')   // –£–¥–∞–ª–∏—Ç—å # –≤ –∫–æ–Ω—Ü–µ
    .replace(/üí°\s*\*\*\s*$/, '') // –£–¥–∞–ª–∏—Ç—å –Ω–µ–ø–æ–ª–Ω—ã–π CTA —Å —ç–º–æ–¥–∑–∏
    .replace(/[‚úì‚úÖ‚ùå‚ö†Ô∏è‚ÑπÔ∏è]\s*$/, '') // –£–¥–∞–ª–∏—Ç—å –æ–¥–∏–Ω–æ—á–Ω—ã–µ —ç–º–æ–¥–∑–∏ –≤ –∫–æ–Ω—Ü–µ
    .trim();

  return trimmed;
}

/**
 * –°—Ç—Ä–æ–∏—Ç –ø–æ–ª–Ω—ã–π —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –∏–∑ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∫–∞–Ω–∞–ª–∞
 * –û–±—ä–µ–¥–∏–Ω—è–µ—Ç –≤—Å–µ —Å–µ–∫—Ü–∏–∏: –ø—Ä–æ–º–ø—Ç, –∏—Å—Ç–æ—á–Ω–∏–∫–∏, —Å—Ç–∏–ª–∏, –ø—Ä–∞–≤–∏–ª–∞, —Å—Ç—Ä—É–∫—Ç—É—Ä—É
 * @param {object} channel - –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∫–∞–Ω–∞–ª–∞ —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–º–∏ –ø–æ–ª—è–º–∏
 * @returns {string} - –ü–æ–ª–Ω—ã–π —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç
 */
export function buildFullSystemPrompt(channel) {
  let prompt = channel.systemPrompt + '\n\n';

  // –î–æ–±–∞–≤–ª—è–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
  if (channel.sources?.inspirationChannels?.length) {
    prompt += '–ö–ê–ù–ê–õ–´ –î–õ–Ø –í–î–û–•–ù–û–í–ï–ù–ò–Ø:\n';
    prompt += channel.sources.inspirationChannels.map(c => `- ${c}`).join('\n');
    prompt += '\n\n';
  }

  if (channel.sources?.referenceUrls?.length) {
    prompt += '–°–°–´–õ–ö–ò –î–õ–Ø –°–ü–†–ê–í–û–ö:\n';
    prompt += channel.sources.referenceUrls.map(u => `- ${u}`).join('\n');
    prompt += '\n\n';
  }

  if (channel.sources?.notes) {
    prompt += `–ü–†–ò–ú–ï–ß–ê–ù–ò–ï –û –ò–°–¢–û–ß–ù–ò–ö–ê–•:\n${channel.sources.notes}\n\n`;
  }

  // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–º—ã –∫–æ–Ω—Ç–µ–Ω—Ç–∞
  if (channel.contentStyle?.topics?.length) {
    prompt += '–¢–ï–ú–´ –î–õ–Ø –ü–û–°–¢–û–í:\n';
    prompt += channel.contentStyle.topics.map(t => `- ${t}`).join('\n');
    prompt += '\n\n';
  }

  // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º–∞—Ç—ã –∫–æ–Ω—Ç–µ–Ω—Ç–∞
  if (channel.contentStyle?.formats?.length) {
    prompt += '–§–û–†–ú–ê–¢–´ –ö–û–ù–¢–ï–ù–¢–ê:\n';
    prompt += channel.contentStyle.formats.map(f => `- ${f}`).join('\n');
    prompt += '\n\n';
  }

  // –î–æ–±–∞–≤–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Å—Ç–∏–ª—è
  if (channel.contentStyle?.writingGuidelines) {
    const wg = channel.contentStyle.writingGuidelines;
    prompt += '–ü–ê–†–ê–ú–ï–¢–†–´ –°–¢–ò–õ–Ø:\n';
    prompt += `- –¢–æ–Ω: ${wg.tone}\n`;
    prompt += `- –î–ª–∏–Ω–∞: ${wg.length.min}-${wg.length.max} —Å–∏–º–≤–æ–ª–æ–≤\n`;
    if (wg.useEmoji) prompt += '- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç–º–æ–¥–∑–∏: –¥–∞\n';
    if (wg.includeCTA) prompt += '- –î–æ–±–∞–≤–ª—è—Ç—å CTA: –¥–∞\n';
    prompt += '\n';
  }

  // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∞–≤–∏–ª–∞ –Ω–∞–ø–∏—Å–∞–Ω–∏—è
  if (channel.contentRules?.doWrite?.length) {
    prompt += '–ß–¢–û –ü–ò–°–ê–¢–¨:\n';
    prompt += channel.contentRules.doWrite.map(r => `‚úÖ ${r}`).join('\n');
    prompt += '\n\n';
  }

  if (channel.contentRules?.dontWrite?.length) {
    prompt += '–ß–ï–ì–û –ò–ó–ë–ï–ì–ê–¢–¨:\n';
    prompt += channel.contentRules.dontWrite.map(r => `‚ùå ${r}`).join('\n');
    prompt += '\n\n';
  }

  // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø–æ—Å—Ç–∞
  if (channel.postStructure?.length) {
    prompt += '–°–¢–†–£–ö–¢–£–†–ê –ü–û–°–¢–ê:\n';
    prompt += channel.postStructure.map((s, i) => `${i + 1}. ${s}`).join('\n');
    prompt += '\n\n';
  }

  // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∞–≤–∏–ª–∞ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª–∏–∑–º–∞
  if (channel.contentStyle?.writingGuidelines?.professionalism) {
    prompt += '–ü–†–ê–í–ò–õ–ê –ü–†–û–§–ï–°–°–ò–û–ù–ê–õ–¨–ù–û–ì–û –ü–ò–°–¨–ú–ê:\n';
    prompt += '‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ –∏ –¥–∏–µ—Ç–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ —Ç–µ—Ä–º–∏–Ω—ã\n';
    prompt += '‚úÖ –û–±—ä—è—Å–Ω—è–π –¥–æ—Å—Ç—É–ø–Ω–æ, –Ω–æ –ù–ï —É–ø—Ä–æ—â–∞–π –¥–æ –Ω–µ–ø—Ä–∞–≤–¥—ã\n';
    prompt += '‚úÖ –ü–∏—à–∏ –∫–∞–∫ –æ–ø—ã—Ç–Ω—ã–π —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç (–¥–∏–µ—Ç–æ–ª–æ–≥/–≤—Ä–∞—á), –∞ –Ω–µ –∫–∞–∫ –æ–±—ã—á–Ω—ã–π —á–µ–ª–æ–≤–µ–∫\n';
    prompt += '‚úÖ –°–æ—Ö—Ä–∞–Ω—è–π –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å –∏ "–≤–∫—É—Å"\n';
    prompt += '‚úÖ –ë–∞–ª–∞–Ω—Å: –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å–Ω–∞—è –º–µ–¥–∏—Ü–∏–Ω–∞ + —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è/–ø—Ä–µ–≤–µ–Ω—Ç–∏–≤–Ω–∞—è –º–µ–¥–∏—Ü–∏–Ω–∞\n';
    prompt += '‚úÖ –°—Ç–∞—Ç—å–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–µ (900-1200 —Å–∏–º–≤–æ–ª–æ–≤), –Ω–µ –∫–æ—Ä–æ—Ç–∫–∏–µ —Ç–∏–∑–µ—Ä—ã\n';
    prompt += '‚úÖ –í–∫–ª—é—á–∞–π —Å—Å—ã–ª–∫–∏ –Ω–∞ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è, –µ—Å–ª–∏ —É–ø–æ–º–∏–Ω–∞–µ—à—å –∏—Ö\n\n';
    prompt += '‚ùå –ò–∑–±–µ–≥–∞–π —Å–ª–µ–Ω–≥–∞ –∏ –¥—Ä—É–∂–µ—Å–∫–æ–≥–æ —Ç–æ–Ω–∞ ("–¥—Ä—É–∂–±–∞–Ω")\n';
    prompt += '‚ùå –ù–µ –ø–∏—à–∏ –∫–∞–∫ –ø—Ä–æ—Å—Ç–æ–π –æ–±—ã–≤–∞—Ç–µ–ª—å\n';
    prompt += '‚ùå –ù–µ —É–ø—Ä–æ—â–∞–π –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ —Ç–µ—Ä–º–∏–Ω—ã –¥–æ –ø–æ—Ç–µ—Ä–∏ —Å–º—ã—Å–ª–∞\n';
    prompt += '‚ùå –ù–µ —Å–æ–∑–¥–∞–≤–∞–π –∫–æ—Ä–æ—Ç–∫–∏–µ —Ç–∏–∑–µ—Ä—ã\n';
  }

  return prompt;
}

/**
 * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫–æ–Ω—Ç–µ–Ω—Ç —á–µ—Ä–µ–∑ Claude AI
 * @param {string} sourceText - –ò—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏
 * @param {string|object} systemPromptOrChannel - System prompt —Å—Ç—Ä–æ–∫–∞ –∏–ª–∏ –æ–±—ä–µ–∫—Ç –∫–∞–Ω–∞–ª–∞
 * @returns {Promise<string>} - –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç
 */
export async function generateContent(sourceText, systemPromptOrChannel) {
  try {
    const isChannel = typeof systemPromptOrChannel === 'object';
    const systemPrompt = isChannel
      ? buildFullSystemPrompt(systemPromptOrChannel)
      : systemPromptOrChannel;

    logger.info(`Generating content with system prompt: ${systemPrompt.substring(0, 50)}...`);

    const message = await client.messages.create({
      model: 'claude-opus-4-1',
      max_tokens: 2000,
      messages: [
        {
          role: 'user',
          content: `–¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∏—Ä—É–π —ç—Ç–æ—Ç –∫–æ–Ω—Ç–µ–Ω—Ç –≤ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π Telegram –ø–æ—Å—Ç.

–¢–†–ï–ë–û–í–ê–ù–ò–Ø:
- –î–ª–∏–Ω–∞: 900-1200 —Å–∏–º–≤–æ–ª–æ–≤ (—ç—Ç–æ –æ—á–µ–Ω—å –≤–∞–∂–Ω–æ!)
- –í—Ä–µ–º—è —á—Ç–µ–Ω–∏—è: ~1 –º–∏–Ω—É—Ç–∞
- –≠—Ç–æ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–ª–Ω–∞—è, –∑–∞–∫–æ–Ω—á–µ–Ω–Ω–∞—è —Å—Ç–∞—Ç—å—è, –ù–ï —Ç–∏–∑–µ—Ä
- –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ç–æ–Ω
- –í–∫–ª—é—á–∏ –≤—ã–≤–æ–¥—ã –∏ CTA –≤ –∫–æ–Ω—Ü–µ

–ö–û–ù–¢–ï–ù–¢ –î–õ–Ø –¢–†–ê–ù–°–§–û–†–ú–ê–¶–ò–ò:
${sourceText}`,
        },
      ],
      system: systemPrompt,
    });

    let generatedText = message.content[0].type === 'text' ? message.content[0].text : '';

    // –û–±—Ä–µ–∑–∞–µ–º —Ç–µ–∫—Å—Ç –Ω–∞ –ø–æ–ª–Ω–æ–º —Å–ª–æ–≤–µ
    generatedText = trimTextAtWordBoundary(generatedText, 4096);

    logger.info('‚úì Content generated successfully');
    return generatedText;
  } catch (error) {
    logger.error(`Failed to generate content: ${error.message}`);
    throw error;
  }
}

/**
 * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫–æ–Ω—Ç–µ–Ω—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏–¥–µ–∏ (–±–µ–∑ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞)
 * @param {string} idea - –ò–¥–µ—è –¥–ª—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞
 * @param {string|object} systemPromptOrChannel - System prompt —Å—Ç—Ä–æ–∫–∞ –∏–ª–∏ –æ–±—ä–µ–∫—Ç –∫–∞–Ω–∞–ª–∞
 * @returns {Promise<string>} - –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç
 */
export async function generateFromIdea(idea, systemPromptOrChannel) {
  try {
    const isChannel = typeof systemPromptOrChannel === 'object';
    const systemPrompt = isChannel
      ? buildFullSystemPrompt(systemPromptOrChannel)
      : systemPromptOrChannel;

    logger.info(`Generating content from idea: ${idea.substring(0, 50)}...`);

    const message = await client.messages.create({
      model: 'claude-opus-4-1',
      max_tokens: 2000,
      messages: [
        {
          role: 'user',
          content: `–°–æ–∑–¥–∞–π –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π Telegram –ø–æ—Å—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ —ç—Ç–æ–π –∏–¥–µ–∏.

–¢–†–ï–ë–û–í–ê–ù–ò–Ø:
- –î–ª–∏–Ω–∞: 900-1200 —Å–∏–º–≤–æ–ª–æ–≤ (—ç—Ç–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ!)
- –í—Ä–µ–º—è —á—Ç–µ–Ω–∏—è: ~1 –º–∏–Ω—É—Ç–∞
- –ü–æ–ª–Ω—ã–π, –∑–∞–∫–æ–Ω—á–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –æ—Ç –Ω–∞—á–∞–ª–∞ –¥–æ –∫–æ–Ω—Ü–∞
- –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Å—Ç–∏–ª—å
- –í–∫–ª—é—á–∏ –≤–≤–æ–¥–Ω—É—é —á–∞—Å—Ç—å, –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç –∏ –≤—ã–≤–æ–¥—ã —Å CTA

–ò–î–ï–Ø:
${idea}`,
        },
      ],
      system: systemPrompt,
    });

    let generatedText = message.content[0].type === 'text' ? message.content[0].text : '';

    // –û–±—Ä–µ–∑–∞–µ–º —Ç–µ–∫—Å—Ç –Ω–∞ –ø–æ–ª–Ω–æ–º —Å–ª–æ–≤–µ
    generatedText = trimTextAtWordBoundary(generatedText, 4096);

    logger.info('‚úì Content generated from idea successfully');
    return generatedText;
  } catch (error) {
    logger.error(`Failed to generate content from idea: ${error.message}`);
    throw error;
  }
}

/**
 * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç Telegram –ø–æ—Å—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–∞—Ä—Å–µ–Ω–Ω–æ–π –≤–µ–±-—Å—Ç–∞—Ç—å–∏
 * @param {object} article - –û–±—ä–µ–∫—Ç —Å—Ç–∞—Ç—å–∏ (title, content, preview, referenceLinks, source)
 * @param {object} channel - –û–±—ä–µ–∫—Ç –∫–∞–Ω–∞–ª–∞ —Å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π
 * @param {string} dayTheme - –¢–µ–º–∞ –¥–Ω—è (oncology, nutrition, longevity, wellness, case_study, weight_loss, qa_inspiration)
 * @returns {Promise<string>} - –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ—Å—Ç (900-1200 —Å–∏–º–≤–æ–ª–æ–≤)
 */
export async function generateFromWebContent(article, channel, dayTheme) {
  try {
    // –°—Ç—Ä–æ–∏–º —Å–∏—Å—Ç–µ–º-–ø—Ä–æ–º–ø—Ç —Å –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–º–∏ –ø—Ä–∞–≤–∏–ª–∞–º–∏
    let systemPrompt = buildFullSystemPrompt(channel);

    // –î–æ–±–∞–≤–ª—è–µ–º —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è –∫–∞–∂–¥–æ–π —Ç–µ–º—ã –¥–Ω—è
    systemPrompt += '\n\n–°–ü–ï–¶–ò–ê–õ–¨–ù–´–ï –ò–ù–°–¢–†–£–ö–¶–ò–ò –î–õ–Ø –¢–ï–ú–´:\n';

    switch (dayTheme) {
      case 'oncology':
        systemPrompt += `–¢–µ–º–∞: –û–ù–ö–û–õ–û–ì–ò–Ø
- –î–µ–ª–∏–∫–∞—Ç–Ω–∞—è, —É–≤–∞–∂–∏—Ç–µ–ª—å–Ω–∞—è –ø–æ–¥–∞—á–∞
- –§–æ–∫—É—Å –Ω–∞ –ø—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫—É, –ø–æ–¥–¥–µ—Ä–∂–∫—É, –Ω–∞–¥–µ–∂–¥—É
- –ë–ï–ó –ø—Ä–æ–¥–∞–∂–∏ —É—Å–ª—É–≥ –∏–ª–∏ –ø—Ä–æ–≥—Ä–∞–º–º
- CTA: —Ç–æ–ª—å–∫–æ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –æ–±—Å—É–¥–∏—Ç—å –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è—Ö –∏–ª–∏ –∑–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å—ã
- –ò—Å–ø–æ–ª—å–∑—É–π –Ω–∞—É—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è
- –°–æ—Ö—Ä–∞–Ω—è–π –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∏ —Å–æ—á—É–≤—Å—Ç–≤–µ–Ω–Ω—ã–π —Ç–æ–Ω`;
        break;

      case 'nutrition':
        systemPrompt += `–¢–µ–º–∞: –ü–ò–¢–ê–ù–ò–ï –ò –†–ê–ó–í–ï–ù–ß–ê–ù–ò–ï –ú–ò–§–û–í
- –ë–∞–ª–∞–Ω—Å: –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å–Ω–∞—è –º–µ–¥–∏—Ü–∏–Ω–∞ + —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è/–ø—Ä–µ–≤–µ–Ω—Ç–∏–≤–Ω–∞—è –º–µ–¥–∏—Ü–∏–Ω–∞
- –†–∞–∑–≤–µ–Ω—á–∏–≤–∞–π —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—ë–Ω–Ω—ã–µ –º–∏—Ñ—ã —Å –Ω–∞—É—á–Ω–æ–π –±–∞–∑–æ–π
- Holistic –ø–æ–¥—Ö–æ–¥, –Ω–æ —Å –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ–º
- CTA: –ø—Ä–µ–¥–ª–æ–∂–∏ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–æ–≤–µ—Ç, –∑–∞–¥–∞–π –≤–æ–ø—Ä–æ—Å –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è—Ö
- –í–∫–ª—é—á–∞–π –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Å–æ–≤–µ—Ç—ã –∏ –ø—Ä–∏–º–µ—Ä—ã`;
        break;

      case 'longevity':
        systemPrompt += `–¢–µ–º–∞: –î–û–õ–ì–û–õ–ï–¢–ò–ï –ò –ë–ò–û–•–ê–ö–ò–ù–ì
- Cutting-edge –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –æ –¥–æ–ª–≥–æ–ª–µ—Ç–∏–∏
- –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –º–µ–¥–∏—Ü–∏–Ω–∞ –∏ science-based –±–∏–æ—Ö–∞–∫–∏–Ω–≥
- –§–æ–∫—É—Å –Ω–∞ –¥–æ–∫–∞–∑–∞–Ω–Ω—ã–µ –º–µ—Ç–æ–¥—ã –∏ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è
- CTA: –ø—Ä–∏–≥–ª–∞—Å–∏ —á–∏—Ç–∞—Ç–µ–ª–µ–π —É–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ, –∑–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å—ã
- –£–ø–æ—Ä –Ω–∞ –∫–∞—á–µ—Å—Ç–≤–æ –∂–∏–∑–Ω–∏, –∞ –Ω–µ –ø—Ä–æ—Å—Ç–æ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å`;
        break;

      case 'wellness':
        systemPrompt += `–¢–µ–º–∞: WELLNESS –ò –ì–õ–û–ë–ê–õ–¨–ù–´–ï –¢–†–ï–ù–î–´
- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–Ω–¥—ã –∑–¥–æ—Ä–æ–≤–æ–≥–æ –æ–±—Ä–∞–∑–∞ –∂–∏–∑–Ω–∏
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Ä–∞–∑–Ω—ã—Ö –ø–æ–¥—Ö–æ–¥–æ–≤: –≤–æ—Å—Ç–æ—á–Ω—ã–µ –∏ –∑–∞–ø–∞–¥–Ω—ã–µ –ø—Ä–∞–∫—Ç–∏–∫–∏
- –§–æ–∫—É—Å –Ω–∞ —Ü–µ–ª–æ—Å—Ç–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –∫ –∑–¥–æ—Ä–æ–≤—å—é
- CTA: –ø–æ–¥–µ–ª–∏—Ç–µ—Å—å —Å–≤–æ–∏–º –æ–ø—ã—Ç–æ–º, –æ–±—Å—É–¥–∏–º –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è—Ö`;
        break;

      case 'case_study':
        systemPrompt += `–¢–µ–º–∞: –ö–ï–ô–° –ü–ê–¶–ò–ï–ù–¢–ê (–ú–û–ù–ï–¢–ò–ó–ê–¶–ò–Ø)
‚ö†Ô∏è –û–ß–ï–ù–¨ –í–ê–ñ–ù–û - –°–¢–†–£–ö–¢–£–†–ê –ú–û–ù–ï–¢–ò–ó–ê–¶–ò–ò:
1. –ó–∞—Ö–≤–∞—Ç—ã–≤–∞—é—â–∏–π –∫–µ–π—Å –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
2. –û—Å–Ω–æ–≤–Ω—ã–µ —à–∞–≥–∏ —Ä–µ—à–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º—ã
3. –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –≤—ã–≤–æ–¥—ã
4. CTA - –¢–†–Å–•–£–†–û–í–ù–ï–í–û–ï –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:
   - –£—Ä–æ–≤–µ–Ω—å 1: –ë–∞–∑–æ–≤–∞—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è (–¥–µ—à–µ–≤–ª–µ, –¥–ª—è –≤—Å–µ—Ö)
   - –£—Ä–æ–≤–µ–Ω—å 2: 4-–Ω–µ–¥–µ–ª—å–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ (—Å—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞, –¥–ª—è –±–æ–ª–µ–µ —Å–µ—Ä—å—ë–∑–Ω—ã—Ö)
   - –£—Ä–æ–≤–µ–Ω—å 3: "Health as a Project" (–ü–†–ï–ú–ò–£–ú, —ç–∫—Å–∫–ª—é–∑–∏–≤–æ, —Ç–æ–ª—å–∫–æ –¥–ª—è –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö, –¥–æ—Ä–æ–≥–æ)
   –ü–æ–¥—á–µ—Ä–∫–Ω–∏: "Health as a Project - —ç—Ç–æ –ø—Ä–µ–º–∏–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ –¥–ª—è —Ç–µ—Ö, –∫—Ç–æ –≥–æ—Ç–æ–≤ –∏–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ —Å–≤–æ—ë –∑–¥–æ—Ä–æ–≤—å–µ"
5. –°–∏–ª—å–Ω—ã–π –ø—Ä–∏–∑—ã–≤ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –∏–ª–∏ —É–∑–Ω–∞—Ç—å –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏`;
        break;

      case 'weight_loss':
        systemPrompt += `–¢–µ–º–∞: –°–ù–ò–ñ–ï–ù–ò–ï –í–ï–°–ê –ò –ó–î–û–†–û–í–û–ï –ü–û–•–£–î–ï–ù–ò–ï
- –ù–∞—É—á–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –∫ —Å–Ω–∏–∂–µ–Ω–∏—é –≤–µ—Å–∞
- –ë–∞–ª–∞–Ω—Å: –∫–∞–ª–æ—Ä–∏–∏ + –º–µ—Ç–∞–±–æ–ª–∏–∑–º + –ø—Å–∏—Ö–æ–ª–æ–≥–∏—è + –ø–∏—Ç–∞–Ω–∏–µ
- –ù–µ –ø—É–≥–∞–π –¥–∏–µ—Ç–∞–º–∏, –ø—Ä–µ–¥–ª–æ–∂–∏ –∑–¥–æ—Ä–æ–≤—ã–π –æ–±—Ä–∞–∑ –∂–∏–∑–Ω–∏
- CTA: –ø—Ä–µ–¥–ª–æ–∂–∏ –ø–æ—à–∞–≥–æ–≤—ã–π –ø–ª–∞–Ω, –≤–æ–ø—Ä–æ—Å—ã –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è—Ö`;
        break;

      case 'qa_inspiration':
        systemPrompt += `–¢–µ–º–∞: Q&A / –í–î–û–•–ù–û–í–ï–ù–ò–ï / –ï–ñ–ï–ù–ï–î–ï–õ–¨–ù–´–ô –û–ë–ó–û–†
- –û—Ç–≤–µ—Ç—å –Ω–∞ —á–∞—Å—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã –∏–ª–∏ –¥–∞–π –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–π –æ–±–∑–æ—Ä —Ç—Ä–µ–Ω–¥–æ–≤
- –í–¥–æ—Ö–Ω–æ–≤–ª—è–π –∏ –º–æ—Ç–∏–≤–∏—Ä—É–π –∞—É–¥–∏—Ç–æ—Ä–∏—é
- –£–∫—Ä–µ–ø–ª—è–π –¥–æ–≤–µ—Ä–∏–µ –∏ –∞–≤—Ç–æ—Ä–∏—Ç–µ—Ç
- CTA: —á—Ç–æ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –Ω–∞ —ç—Ç–æ–π –Ω–µ–¥–µ–ª–µ, –≤–∞—à–∏ –≤–æ–ø—Ä–æ—Å—ã –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é—Ç—Å—è`;
        break;
    }

    // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∏—Å—Ö–æ–¥–Ω–æ–π —Å—Ç–∞—Ç—å–µ
    systemPrompt += `\n\n–ò–°–•–û–î–ù–ê–Ø –°–¢–ê–¢–¨–Ø:
–ò—Å—Ç–æ—á–Ω–∏–∫: ${article.source || article.sourceUrl}
–ó–∞–≥–æ–ª–æ–≤–æ–∫: ${article.title}`;

    if (article.referenceLinks && article.referenceLinks.length > 0) {
      systemPrompt += `\n–°—Å—ã–ª–∫–∏ –Ω–∞ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è (–°–û–•–†–ê–ù–ò–¢–¨ –í –ü–û–°–¢–ï):
${article.referenceLinks.map((link, i) => `${i + 1}. ${link}`).join('\n')}`;
    }

    logger.info(`Generating post for theme: ${dayTheme} from article: "${article.title}"`);

    const message = await client.messages.create({
      model: 'claude-opus-4-1',
      max_tokens: 2500,  // –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–π —Å—Ç–∞—Ç—å–∏ 900-1200 —Å–∏–º–≤–æ–ª–æ–≤ —Å –≤—ã–≤–æ–¥–∞–º–∏
      messages: [
        {
          role: 'user',
          content: `–ù–∞ –æ—Å–Ω–æ–≤–µ —Å–ª–µ–¥—É—é—â–µ–π —Å—Ç–∞—Ç—å–∏ —Å–æ–∑–¥–∞–π –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π –∞–≤—Ç–æ—Ä—Å–∫–∏–π Telegram –ø–æ—Å—Ç –¥–ª—è –∫–∞–Ω–∞–ª–∞ –æ –∑–¥–æ—Ä–æ–≤—å–µ –∏ –º–µ–¥–∏—Ü–∏–Ω–µ.

–¢–†–ï–ë–û–í–ê–ù–ò–Ø (–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–´!):
- –î–ª–∏–Ω–∞: –†–û–í–ù–û 900-1200 —Å–∏–º–≤–æ–ª–æ–≤ (–≤—Ä–µ–º—è —á—Ç–µ–Ω–∏—è ~1 –º–∏–Ω—É—Ç–∞)
- –ü–û–õ–ù–ê–Ø, –∑–∞–∫–æ–Ω—á–µ–Ω–Ω–∞—è —Å—Ç–∞—Ç—å—è, –ù–ï —Ç–∏–∑–µ—Ä
- –°—Ç—Ä—É–∫—Ç—É—Ä–∞: –≤–≤–æ–¥–Ω–∞—è —á–∞—Å—Ç—å ‚Üí –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç ‚Üí –≤—ã–≤–æ–¥—ã ‚Üí CTA
- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∏–∑ —Å—Ç–∞—Ç—å–∏ –ø–µ—Ä–µ—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∞ –≤ –∞–≤—Ç–æ—Ä—Å–∫–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç
- –°—Å—ã–ª–∫–∏ –Ω–∞ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã (–µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å)
- –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ç–æ–Ω, –∫–∞–∫ –æ—Ç –æ–ø—ã—Ç–Ω–æ–≥–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞
- –ë–ï–ó —Å–ª–µ–Ω–≥–∞
- CTA —É–º–µ—Å—Ç–Ω—ã–π –¥–ª—è —Ç–µ–º—ã "${dayTheme}"

–ò–°–•–û–î–ù–ê–Ø –°–¢–ê–¢–¨–Ø:
${article.preview || article.content || '–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞'}`,
        },
      ],
      system: systemPrompt,
    });

    let generatedText = message.content[0].type === 'text' ? message.content[0].text : '';

    // –û–±—Ä–µ–∑–∞–µ–º —Ç–µ–∫—Å—Ç –Ω–∞ –ø–æ–ª–Ω–æ–º —Å–ª–æ–≤–µ (–º–∞–∫—Å–∏–º—É–º 4096 –¥–ª—è Telegram)
    generatedText = trimTextAtWordBoundary(generatedText, 4096);

    logger.info(`‚úì Post generated (${generatedText.length} characters) for theme: ${dayTheme}`);

    return generatedText;
  } catch (error) {
    logger.error(`Failed to generate content from web article: ${error.message}`);
    throw error;
  }
}

export default {
  generateContent,
  generateFromIdea,
  generateFromWebContent,
  buildFullSystemPrompt,
};
